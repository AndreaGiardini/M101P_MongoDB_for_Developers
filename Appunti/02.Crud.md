Week 2 - Crud
=============

CRUD and the Mongo Shell
------------------------

L'acronimo CRUD (Create Read Update Delete) indica una serie di operazioni che è possibile effettuare su qualsiasi database. In mongoDB queste operazioni vengono rinominate con questa terminologia (Lettera, op. DBMS, op. MongoDB):

- C - Create - Insert
- R - Read - Find
- U - Update - Update
- D - Delete - Remove

La particolarità di MongoDB è nel fatto che non ha un proprio linguaggio si interrogazione (come SQL nel RDBMS) ma tutte le operazioni che possono essere eseguite sul database esistono sotto forma di chiamate API. E' la chiamata a metodi o funzioni che causa la trasmissione di dati nella rete, in rispetto dei protocolli definiti da MongoDB, non o più bisogno di manipolare stringhe per creare una query SQL sintatticamente corretta.

E' ovviamente possibile eseguire queste operazioni sia da Mongo Shell sia su Python tramite la libreria pymongo.

Secrets of the Mongo Shell
--------------------------

La Mongo Shell non è altro che un interprete Javascript che permette di interagire e collegarsi con un database MongoDB ed effettuare operazioni su di esso. E' possibile accedere alla MongoShell tramite il comando:

```bash
mongo
```

Che ci porterà direttamente all'interno della shell, stampando il database a cui si è attualmente collegati e la versione della shell. E' buona pratica tenere la versione della shell e quella del DB sempre sincronizzate, onde evitare possibili incompatibilità.

La Mongo shell, come detto precedentemente, è a tutti gli effetti un interprete JavaScript, quindi è possibile scrivere cose di questo tipo:

```javascript
for(i=0; i < 3; i++) print("Hello");
```

In Javascript è possibile creare oggetti e attribuire loro proprietà in questo modo:

```javascript
x = 1
y = "abc"
z = { a : 1 }
z.a
z["a"]
```

Come è possibile vedere, posso accedere al campo "a" della variabile z tramite due metodi: uno con il punto e l'altro tramite parentesi quadre. La differenza sta nel fatto che con il primo metodo non è possibile effettuare il lookup delle variabili, mentre con il secondo si: se volessi accedere ad un oggetto specificando la chiave tramite variabile potrei farlo nel nel secondo modo ma non con il primo.

Introduction to find
--------------------

```javascript
doc = { "name" : "Smith", "age" : 30, "profession" : "hacker"}
db.people.insert( doc )
db.people.find()
```

Come è possibile vedere ad ogni oggetto viene aggiunto un nuovo campo _id contenente un ObjectId() univoco all'interno della collezione. Questo _id è a tutti gli effetti una chiave primaria che viene generata ogni volta che viene inserito un oggetto: non è possibile modificarla ed è creata mettendo in relazione un insieme di paramentri che la rendono univoca.

Tutte le operazioni CRUD sono rappresentate come metodi su una collezione. Il metodo findOne() ritorna un valore casuale di quella collezione, oppure è possibile specificare un criterio di ricerca.

```javascript
db.people.findOne()
db.people.findOne({ "name" : "Jones" })
```

E' possibile inoltre specificare, all'interno del metodo findOne, quali parametri voglio visualizzare e quali escludere, inserendo il loro nome all'interno del dizionario. E' però importante specificare che di default il campo _id viene sempre mostrato anche se non viene richiesto, è dunque necessario escluderlo manualmente se non vogliamo che appaia all'interno dei risultati di ricerca.

```javascript
db.people.findOne({ "name" : "Jones" }, { "name" : true, "_id" : false})
db.people.findOne({ "name" : "Jones" }, { "name" : true})
```
Il comando find ritorna invece la lista di tutti gli elementi che corrispondono ad una query, non solo uno.

```javascript
db.scores.find({ "type" : "essay", "score" : 50 }, { "student" : true, "_id" : false })
```
Sono presenti inoltre alcuni operatori che ci permettono di fare query più complesse. Due di questi sono gli operatori $lt (less than) e $gt (greater that), che è possibile trovare anche nelle loro varianti $lte (less or equal than) e $ gte (greater or equal than). E' possibile utilizzare questi operatori anche con le stringhe.

```javascript
db.scores.find({ score : { $gt : 95, $lte : 98}, type : "essay"})
db.scores.find({ name : { $lt : "D", $gt : "b"}})
```
Esistono poi chiavi di ricerca avanzate come $exists, che seleziona solo oggetti con un determinato campo, o $type, che seleziona solo oggetti aventi un determinato tipo (specificato tramite indice BSON), o addirittura possiamo specificare espressioni regolari per filtrare le stringhe.

```javascript
/* Tutti gli oggetti in cui esiste la chiave "profession" */
db.people.find({ profession : { $exists : true }})
/* Tutti gli oggetti in cui il campo "name" è una stringa */
db.people.find({ name : { $type : 2 }})
/* Tutti gli oggetti in cui il campo "name" contiene la lettera "a" */
db.people.find({ name : { $regex : "a" }})
/* Tutti gli oggetti in cui il campo "name" finisce con la lettera "e" */
db.people.find({ name : { $regex : "e$" }})
/* Tutti gli oggetti in cui il campo "name" inizia con la lettera "A" */
db.people.find({ name : { $regex : "^A" }})
```

Operatori or ed and
-------------------

E' possibile specificare un insieme di chiavi di ricerca ed escluderle o includerle.

```javascript
/* Tutti gli oggetti che hanno il nome che termina per "e" o che hanno il campo "age" */
db.people.find( { $or : [ { name : { $regex : "e$"}}, { age : { $exists : true }}]})
```
